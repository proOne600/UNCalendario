#! /usr/bin/env node
"use strict";function check(e,t){return"string"==typeof e?t==e:e&&"function"==typeof e.exec?e.exec(t):"boolean"==typeof e||"object"==typeof e?e:"function"==typeof e&&e(t)}var Parser=require("jsonparse"),through=require("through");exports.parse=function(e,t){function n(e,t){!1!==r&&(r=r||{},r[e]=t),!1!==i&&!1===r&&(i=i||{},i[e]=t)}var r,i,u=new Parser,s=through(function(e){"string"==typeof e&&(e=new Buffer(e)),u.write(e)},function(e){e&&s.write(e),r&&s.emit("header",r),i&&s.emit("footer",i),s.queue(null)});"string"==typeof e&&(e=e.split(".").map(function(e){return"$*"===e?{emitKey:!0}:"*"===e||(""===e?{recurse:!0}:e)}));var o=0;return e&&e.length||(e=null),u.onValue=function(i){if(this.root||(s.root=i),e){for(var u=0,c=0,a=!1,h=!1;u<e.length;){var f,l=e[u];if(c++,l&&!l.recurse){if(!(f=c===this.stack.length?this:this.stack[c]))return;if(!check(l,f.key))return void n(f.key,i);a=!!l.emitKey,h=!!l.emitPath,u++}else{u++;var p=e[u];if(!p)return;for(;;){if(!(f=c===this.stack.length?this:this.stack[c]))return;if(check(p,f.key)){u++,Object.isFrozen(this.stack[c])||(this.stack[c].value=null);break}n(f.key,i),c++}}}if(r&&(s.emit("header",r),r=!1),c===this.stack.length){o++;var k=this.stack.slice(1).map(function(e){return e.key}).concat([this.key]),y=this.value[this.key];null!=y&&null!=(y=t?t(y,k):y)&&((a||h)&&(y={value:y},a&&(y.key=this.key),h&&(y.path=k)),s.queue(y)),delete this.value[this.key];for(var g in this.stack)Object.isFrozen(this.stack[g])||(this.stack[g].value=null)}}},u._onToken=u.onToken,u.onToken=function(t,n){u._onToken(t,n),0===this.stack.length&&s.root&&(e||s.queue(s.root),o=0,s.root=null)},u.onError=function(e){e.message.indexOf("at position")>-1&&(e.message="Invalid JSON ("+e.message+")"),s.emit("error",e)},s},exports.stringify=function(e,t,n,r){r=r||0,!1===e?(e="",t="\n",n=""):null==e&&(e="[\n",t="\n,\n",n="\n]\n");var i,u=!0,s=!1;return i=through(function(n){s=!0;try{var o=JSON.stringify(n,null,r)}catch(e){return i.emit("error",e)}u?(u=!1,i.queue(e+o)):i.queue(t+o)},function(){s||i.queue(e),i.queue(n),i.queue(null)})},exports.stringifyObject=function(e,t,n,r){r=r||0,!1===e?(e="",t="\n",n=""):null==e&&(e="{\n",t="\n,\n",n="\n}\n");var i=!0,u=!1;return through(function(n){u=!0;var s=JSON.stringify(n[0])+":"+JSON.stringify(n[1],null,r);i?(i=!1,this.queue(e+s)):this.queue(t+s)},function(){u||this.queue(e),this.queue(n),this.queue(null)})},module.parent||"browser"===process.title||process.stdin.pipe(exports.parse(process.argv[2])).pipe(exports.stringify("[",",\n","]\n",2)).pipe(process.stdout);